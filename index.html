<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Poem of the Day</title>
    <style>
      :root {
        --bg: #faf8f5;
        --fg: #2c2c2c;
        --muted: #6b6b6b;
        --accent: #8b5e3c;
        --card: #fff;
        --shadow: rgba(0, 0, 0, 0.06);
      }
      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #1a1a1a;
          --fg: #e8e4df;
          --muted: #9a9a9a;
          --accent: #c9a77c;
          --card: #242424;
          --shadow: rgba(0, 0, 0, 0.3);
        }
      }

      * { margin: 0; padding: 0; box-sizing: border-box; }

      body {
        font-family: "Georgia", "Times New Roman", serif;
        background: var(--bg);
        color: var(--fg);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        padding: 3rem 1.5rem;
      }

      main {
        max-width: 640px;
        width: 100%;
      }

      .header {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid var(--shadow);
      }

      .label {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.15em;
        color: var(--accent);
        margin-bottom: 0.75rem;
      }

      h1 {
        font-size: 1.75rem;
        font-weight: 600;
        line-height: 1.3;
        margin-bottom: 0.35rem;
      }

      .author {
        font-size: 1rem;
        color: var(--muted);
        font-style: italic;
      }

      .poem-body {
        font-size: 1.05rem;
        line-height: 1.75;
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .epigraph {
        font-size: 1.05rem;
        font-style: italic;
        line-height: 1.75;
        padding-left: 1.5rem;
        margin-bottom: 1.1em;
        white-space: pre-wrap;
      }

      .poem-body em {
        font-style: italic;
      }

      .poem-body strong {
        font-weight: 700;
      }

      .error {
        text-align: center;
        color: var(--muted);
        padding: 4rem 1rem;
        font-style: italic;
      }

      @media (max-width: 480px) {
        body { padding: 2rem 1rem; }
        h1 { font-size: 1.35rem; }
        .epigraph { font-size: 0.95rem; padding-left: 1rem; }
        .poem-body { font-size: 0.95rem; line-height: 1.65; }
      }
    </style>
  </head>
  <body>
    <main>
      <div class="header">
        <p class="label">Poem of the Day</p>
        <h1 id="poem-title"></h1>
        <p class="author" id="poem-author"></p>
      </div>
      <div class="epigraph" id="poem-epigraph"></div>
      <div class="poem-body" id="poem-text"></div>
    </main>

    <script>
      const poemTitle = document.getElementById("poem-title");
      const poemAuthor = document.getElementById("poem-author");
      const poemEpigraph = document.getElementById("poem-epigraph");
      const poemText = document.getElementById("poem-text");

      /**
       * Convert Markdown-style formatting in poem text to HTML.
       *
       * Handles:
       *   **bold**        → <strong>bold</strong>
       *   _italic_        → <em>italic</em>
       *   *italic*        → <em>italic</em>
       *   ***bold+ital*** → <strong><em>bold+ital</em></strong>
       *
       * Leading whitespace (indentation) is preserved via white-space: pre-wrap
       * on the container. Line breaks become <br>.
       */
      function renderPoem(raw) {
        // 1. Escape HTML entities
        let html = raw
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;");

        // 2. Bold+italic (*** or ___) — must come first
        html = html.replace(
          /(\*\*\*|___)(.+?)\1/gm,
          "<strong><em>$2</em></strong>"
        );

        // 3. Bold (**) 
        html = html.replace(
          /\*\*(.+?)\*\*/gm,
          "<strong>$1</strong>"
        );

        // 4. Italic: _text_ (word-boundary aware to avoid matching snake_case)
        html = html.replace(
          /(^|[\s(["'\u2018\u201c])_([^_\n]+?)_([\s).,;:!?"'\u2019\u201d]|$)/gm,
          "$1<em>$2</em>$3"
        );

        // 5. Italic: *text* (single asterisk, not already inside <strong>)
        html = html.replace(
          /(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/gm,
          "<em>$1</em>"
        );

        // 6. Line breaks
        html = html.replace(/\n/g, "<br>");

        return html;
      }

      fetch("poem.json", { cache: "no-store" })
        .then((r) => r.json())
        .then((data) => {
          if (!data || !data.poem) {
            poemTitle.textContent = "Poem unavailable";
            poemText.innerHTML =
              '<p class="error">Could not load today\u2019s poem.<br>Please run the fetch script again.</p>';
            return;
          }

          poemTitle.textContent = data.title || "Untitled";
          poemAuthor.textContent = data.author ? `by ${data.author}` : "";

          // Epigraph / dedication (may be multi-line / multi-paragraph)
          if (data.epigraph) {
            // Support both string and array (future-proofing)
            const epiText = Array.isArray(data.epigraph)
              ? data.epigraph.join("\n\n")
              : data.epigraph;
            // Render with line breaks (pre-wrap handles \n natively,
            // but we still escape HTML for safety via textContent on a
            // temporary node, then swap to innerHTML with <br>).
            const tmp = document.createElement("span");
            tmp.textContent = epiText;
            poemEpigraph.innerHTML = tmp.innerHTML.replace(/\n/g, "<br>");
            poemEpigraph.style.display = "block";
          } else {
            poemEpigraph.style.display = "none";
          }

          poemText.innerHTML = renderPoem(data.poem);
        })
        .catch(() => {
          poemTitle.textContent = "Poem unavailable";
          poemText.innerHTML =
            '<p class="error">Could not read poem.json.<br>Please regenerate it with the fetch script.</p>';
        });
    </script>
  </body>
</html>
