name: Build iOS Widget IPA

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode project
        run: xcodegen generate

      - name: Show schemes
        run: xcodebuild -project PoemOfTheDay.xcodeproj -list

      - name: Build unsigned
        run: |
          xcodebuild clean build \
            -project PoemOfTheDay.xcodeproj \
            -scheme PoemOfTheDayAppOnly \
            -sdk iphoneos \
            -configuration Release \
            -derivedDataPath build/DerivedData \
            -destination "generic/platform=iOS" \
            ARCHS=arm64 \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGN_ENTITLEMENTS="" \
            DEVELOPMENT_TEAM="" \
            VALIDATE_PRODUCT=NO \
            ENABLE_BITCODE=NO

      - name: Package IPA
        run: |
          set -euo pipefail

          APP=$(find build/DerivedData/Build/Products/Release-iphoneos -maxdepth 1 -name "*.app" -type d | head -1)
          if [ -z "$APP" ]; then
            echo "ERROR: No .app bundle found"
            find build/DerivedData/Build/Products/ -type d
            exit 1
          fi
          echo "Found app: $APP"

          # Show what we're packaging
          echo "--- App bundle structure ---"
          find "$APP" -maxdepth 2 -type f | head -30
          echo ""

          # Check for embedded extension
          if [ -d "$APP/PlugIns" ]; then
            echo "--- Embedded extensions ---"
            ls -la "$APP/PlugIns/"
          fi

          # Build Payload
          mkdir -p Payload
          cp -a "$APP" Payload/

          # Remove PlugIns if present (no extensions in app-only build)
          rm -rf Payload/*.app/PlugIns

          # Strip code signatures (AltStore re-signs everything)
          find Payload -type d -name "_CodeSignature" -exec rm -rf {} + 2>/dev/null || true
          find Payload -name "*.mobileprovision" -delete 2>/dev/null || true
          find Payload -name ".DS_Store" -delete 2>/dev/null || true

          # Create IPA with standard zip
          /usr/bin/zip -r -X PoemOfTheDay.ipa Payload

          # Show IPA contents
          echo ""
          echo "--- IPA contents ---"
          unzip -l PoemOfTheDay.ipa | head -40
          echo ""
          echo "IPA size: $(du -h PoemOfTheDay.ipa | cut -f1)"

          # Validate
          if ! unzip -l PoemOfTheDay.ipa | grep -q "Payload/.*\.app/Info.plist"; then
            echo "FATAL: Invalid IPA â€” missing Payload/*.app/Info.plist"
            exit 1
          fi
          echo "IPA validated OK"

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: PoemOfTheDay
          path: PoemOfTheDay.ipa
          if-no-files-found: error
