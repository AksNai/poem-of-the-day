name: Build iOS IPA

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install XcodeGen
        run: brew install xcodegen

      - name: Generate Xcode project
        run: xcodegen generate

      - name: List schemes
        run: xcodebuild -project PoemOfTheDay.xcodeproj -list

      - name: Archive
        run: |
          xcodebuild archive \
            -project PoemOfTheDay.xcodeproj \
            -scheme PoemOfTheDay \
            -sdk iphoneos \
            -archivePath build/PoemOfTheDay.xcarchive \
            -destination "generic/platform=iOS" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            DEVELOPMENT_TEAM="" \
            ENABLE_BITCODE=NO

      - name: Create IPA
        run: |
          set -euo pipefail

          # Locate .app inside the archive
          APP="build/PoemOfTheDay.xcarchive/Products/Applications/PoemOfTheDay.app"
          if [ ! -d "$APP" ]; then
            echo "App not found at expected path, searching..."
            APP=$(find build/PoemOfTheDay.xcarchive -name "*.app" -type d | head -1)
          fi

          if [ -z "$APP" ] || [ ! -d "$APP" ]; then
            echo "ERROR: No .app found in archive"
            find build/PoemOfTheDay.xcarchive -type d | head -30
            exit 1
          fi
          echo "App: $APP"

          # Verify Info.plist exists and is readable
          echo "--- Info.plist check ---"
          plutil -p "$APP/Info.plist" | head -20
          echo ""

          # Check for embedded widget extension
          echo "--- PlugIns (widget extensions) ---"
          if [ -d "$APP/PlugIns" ]; then
            find "$APP/PlugIns" -type d
          else
            echo "Warning: No PlugIns directory — widget extension may not be embedded."
          fi
          echo ""

          # Build Payload structure
          mkdir Payload
          cp -R "$APP" Payload/

          # Clean up code-signing artifacts (will be re-signed by sideload tool)
          find Payload -name "_CodeSignature" -type d -exec rm -rf {} + 2>/dev/null || true
          find Payload -name "*.mobileprovision" -delete 2>/dev/null || true
          find Payload -name ".DS_Store" -delete 2>/dev/null || true

          # KEEP PlugIns — this is where the widget extension lives!
          echo "--- Payload contents ---"
          find Payload -type f | head -40
          echo ""

          # Create IPA
          /usr/bin/zip -r -X PoemOfTheDay.ipa Payload

          echo "--- IPA listing ---"
          unzip -l PoemOfTheDay.ipa | head -40
          echo ""
          echo "Size: $(du -h PoemOfTheDay.ipa | cut -f1)"

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: PoemOfTheDay
          path: PoemOfTheDay.ipa
          if-no-files-found: error
