name: iOS Preview Screenshots

on:
  workflow_dispatch:
    inputs:
      simulator_name:
        description: "Simulator device name"
        required: false
        default: "iPhone 16"
        type: string
      configuration:
        description: "Build configuration"
        required: false
        default: "Debug"
        type: choice
        options:
          - Debug
          - Release

permissions:
  contents: read

jobs:
  simulator-preview:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install XcodeGen
        shell: bash
        run: |
          set -euo pipefail
          brew install xcodegen

      - name: Generate Xcode project
        shell: bash
        run: |
          set -euo pipefail
          xcodegen generate

      - name: Build and capture screenshots
        shell: bash
        env:
          SIMULATOR_NAME: ${{ inputs.simulator_name }}
          CONFIGURATION: ${{ inputs.configuration }}
        run: |
          set -euo pipefail

          mkdir -p preview

          RUNTIME_ID=$(xcrun simctl list runtimes -j | python3 -c 'import json,sys; data=json.load(sys.stdin); ios=[r for r in data.get("runtimes",[]) if r.get("isAvailable") and r.get("identifier","" ).startswith("com.apple.CoreSimulator.SimRuntime.iOS-")]; ios=sorted(ios, key=lambda r:r.get("version",""), reverse=True); print(ios[0]["identifier"] if ios else "")')
          if [[ -z "$RUNTIME_ID" ]]; then
            echo "No available iOS runtime found"
            exit 1
          fi

          DEVICE_ID=$(xcrun simctl create "PoemPreview" "$SIMULATOR_NAME" "$RUNTIME_ID")
          echo "Using simulator id: $DEVICE_ID"

          xcrun simctl boot "$DEVICE_ID"
          xcrun simctl bootstatus "$DEVICE_ID" -b

          xcodebuild \
            -project PoemOfTheDay.xcodeproj \
            -scheme PoemOfTheDay \
            -configuration "$CONFIGURATION" \
            -destination "id=$DEVICE_ID" \
            -derivedDataPath build/DerivedData \
            clean build

          APP_PATH=$(find build/DerivedData/Build/Products -type d -name "PoemOfTheDay.app" | grep iphonesimulator | head -n 1 || true)
          if [[ -z "$APP_PATH" ]]; then
            echo "Could not locate simulator app bundle"
            exit 1
          fi

          xcrun simctl install "$DEVICE_ID" "$APP_PATH"
          xcrun simctl launch "$DEVICE_ID" com.aksha.poemoftheday || true
          sleep 4

          xcrun simctl ui "$DEVICE_ID" appearance light
          sleep 1
          xcrun simctl io "$DEVICE_ID" screenshot "preview/app-light.png"

          xcrun simctl ui "$DEVICE_ID" appearance dark
          sleep 1
          xcrun simctl io "$DEVICE_ID" screenshot "preview/app-dark.png"

          xcrun simctl ui "$DEVICE_ID" home
          sleep 1
          xcrun simctl io "$DEVICE_ID" screenshot "preview/home-screen.png"

          xcrun simctl shutdown "$DEVICE_ID" || true
          xcrun simctl delete "$DEVICE_ID" || true

          {
            echo "### Preview artifacts"
            echo "- app-light.png"
            echo "- app-dark.png"
            echo "- home-screen.png"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload screenshot artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-preview-screenshots
          path: preview/*.png
          if-no-files-found: error
